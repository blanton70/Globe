<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Globe with Species Observations</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    #globeViz {
      height: 100%;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
    }
    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      max-width: 240px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div id="tooltip"></div>

  <div id="controls">
    <label><input type="radio" name="layer" value="satellite" checked> Satellite</label><br>
    <label><input type="radio" name="layer" value="political"> Political</label><br>
    <label><input type="radio" name="layer" value="topo"> Topographic</label><br>
    <label><input type="radio" name="layer" value="ecoregions"> Ecoregions</label><br>
    <hr/>
    <input type="text" id="speciesInput" placeholder="Enter species name (e.g. Panthera leo)">
    <button id="searchBtn">Search</button>
    <hr/>
    <label for="startYearSlider">Start Year: <span id="startYearLabel">1800</span></label><br/>
    <input type="range" id="startYearSlider" min="1800" max="2025" step="1" value="1800"><br/>

    <label for="endYearSlider">End Year: <span id="endYearLabel">2025</span></label><br/>
    <input type="range" id="endYearSlider" min="1800" max="2025" step="1" value="2025"><br/>

    <p id="observationCount">Observations: 0</p>
    <button id="zoomInBtn">Zoom In</button>
    <button id="zoomOutBtn">Zoom Out</button>
  </div>

  <!-- Load Three.js and Globe.gl -->
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script>
    const textureURLs = {
      satellite: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
      political: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Political_World_Map_2021.png',
      topo: 'https://eoimages.gsfc.nasa.gov/images/imagerecords/74000/74192/world.topo.bathy.200412.3x5400x2700.jpg',
      ecoregions: 'https://storage.googleapis.com/eco-globe-maps/ecoregions.jpg'
    };

    const globe = Globe()(document.getElementById('globeViz'))
      .globeImageUrl(textureURLs.satellite)
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .pointAltitude(0.01)
      .pointColor('color')
      .pointRadius('size')
      .labelLat('lat')
      .labelLng('lng')
      .labelText('label')
      .labelSize(1.2)
      .labelDotRadius(0.3)
      .labelColor(() => 'rgba(255,255,255,0.9)');

    const controls = globe.controls();
    controls.autoRotate = false;
    controls.enableZoom = true;
    controls.zoomSpeed = 1.2;
    controls.minDistance = 50;
    controls.maxDistance = 500;

document.getElementById('zoomInBtn').addEventListener('click', () => {
  const cam = globe.camera();
  const controls = globe.controls();

  // Calculate new zoom level, but don't go below minDistance
  const newZ = cam.position.z - 20;
  cam.position.z = newZ < controls.minDistance ? controls.minDistance : newZ;

  controls.update();
});

document.getElementById('zoomOutBtn').addEventListener('click', () => {
  const cam = globe.camera();
  const controls = globe.controls();

  // Calculate new zoom level, but don't go beyond maxDistance
  const newZ = cam.position.z + 20;
  cam.position.z = newZ > controls.maxDistance ? controls.maxDistance : newZ;

  controls.update();
});



    document.querySelectorAll("input[name='layer']").forEach(input => {
      input.addEventListener("change", e => {
        const selected = e.target.value;
        globe.globeImageUrl(textureURLs[selected]);
      });
    });






    const startYearSlider = document.getElementById('startYearSlider');
    const endYearSlider = document.getElementById('endYearSlider');
    const startYearLabel = document.getElementById('startYearLabel');
    const endYearLabel = document.getElementById('endYearLabel');
    const observationCount = document.getElementById('observationCount');

    startYearSlider.addEventListener('input', () => {
      startYearLabel.textContent = startYearSlider.value;
      if (parseInt(startYearSlider.value) > parseInt(endYearSlider.value)) {
        endYearSlider.value = startYearSlider.value;
        endYearLabel.textContent = endYearSlider.value;
      }
    });

    endYearSlider.addEventListener('input', () => {
      endYearLabel.textContent = endYearSlider.value;
      if (parseInt(endYearSlider.value) < parseInt(startYearSlider.value)) {
        startYearSlider.value = endYearSlider.value;
        startYearLabel.textContent = startYearSlider.value;
      }
    });

    const tooltipDiv = document.getElementById('tooltip');

    // ðŸ§  Moved outside search handler â€” this runs ONCE
    globe.onPointHover(point => {
      if (point) {
        tooltipDiv.innerHTML = point.tooltip;
        tooltipDiv.style.display = 'block';
      } else {
        tooltipDiv.style.display = 'none';
      }
    });

    document.addEventListener('mousemove', e => {
      tooltipDiv.style.left = `${e.clientX + 10}px`;
      tooltipDiv.style.top = `${e.clientY + 10}px`;
    });

    document.getElementById('searchBtn').addEventListener('click', async () => {
  const species = document.getElementById('speciesInput').value.trim();
  const startYear = parseInt(startYearSlider.value);
  const endYear = parseInt(endYearSlider.value);
  if (!species) return alert("Please enter a species name.");

  try {
    // Step 1: Get taxonKey for species name
    const matchUrl = `https://api.gbif.org/v1/species/match?name=${encodeURIComponent(species)}`;
    const matchRes = await fetch(matchUrl);
    const matchData = await matchRes.json();

    if (!matchData.usageKey) {
      alert("Species not found in GBIF taxonomy.");
      return;
    }

    const taxonKey = matchData.usageKey;

    // Step 2: Fetch occurrence data by taxonKey
    const occurrenceUrl = `https://api.gbif.org/v1/occurrence/search?taxonKey=${taxonKey}&limit=300&year=${startYear},${endYear}`;
    const occRes = await fetch(occurrenceUrl);
    const occData = await occRes.json();

    // Prepare colors for subspecies
    const colors = [
      '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
      '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
      '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000',
      '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
    ];

    // Map subspecies name to a color
    const subspeciesColorMap = {};
    let colorIndex = 0;

    const points = occData.results
      .filter(obs => obs.decimalLatitude && obs.decimalLongitude)
      .map(obs => {
        const lat = obs.decimalLatitude;
        const lng = obs.decimalLongitude;
        const year = obs.year || "Unknown";
        const country = obs.country || "Unknown";

        // Use subspecies or species or fallback
        const subspecies = obs.subspecies || obs.species || species;

        // Assign color for subspecies
        if (!subspeciesColorMap[subspecies]) {
          subspeciesColorMap[subspecies] = colors[colorIndex % colors.length];
          colorIndex++;
        }
        const pointColor = subspeciesColorMap[subspecies];

        const imageUrl = (obs.media && obs.media.length && obs.media[0].identifier) || null;

        const label = `${subspecies}\n${country}, ${year}`;
        const tooltip = `
          <div style="text-align:left;">
            <strong>${subspecies}</strong><br/>
            <em>${country}</em><br/>
            Year: ${year}<br/>
            Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}<br/>
            ${imageUrl ? `<img src="${imageUrl}" width="100" style="margin-top:5px;border-radius:4px;" />` : ""}
          </div>
        `;

        return {
          lat,
          lng,
          year,
          label,
          tooltip,
          color: pointColor,
          size: 0.4
        };
      });

    globe.pointsData([]);           // Clear previous points
    globe.pointsData(points);       // Set new points
    observationCount.textContent = `Observations: ${points.length}`;
  } catch (err) {
    console.error(err);
    observationCount.textContent = 'Observations: 0';
    alert("Failed to load GBIF data.");
  }
});

     
  </script>
</body>
</html>
