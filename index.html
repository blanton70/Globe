<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Globe with Species Observations</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    #globeViz {
      height: 100%;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
    }
    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      max-width: 240px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div id="tooltip"></div>

  <div id="controls">
    <label><input type="radio" name="layer" value="satellite" checked> Satellite</label><br>
    <label><input type="radio" name="layer" value="political"> Political</label><br>
    <label><input type="radio" name="layer" value="topo"> Topographic</label><br>
    <label><input type="radio" name="layer" value="ecoregions"> Ecoregions</label><br>
    <hr/>
    <input type="text" id="speciesInput" placeholder="Enter species name (e.g. Panthera leo)">
    <button id="searchBtn">Search</button>
    <hr/>
    <label for="startYearSlider">Start Year: <span id="startYearLabel">1800</span></label><br/>
    <input type="range" id="startYearSlider" min="1800" max="2025" step="1" value="1800"><br/>

    <label for="endYearSlider">End Year: <span id="endYearLabel">2025</span></label><br/>
    <input type="range" id="endYearSlider" min="1800" max="2025" step="1" value="2025"><br/>

    <p id="observationCount">Observations: 0</p>
    <button id="zoomInBtn">Zoom In</button>
    <button id="zoomOutBtn">Zoom Out</button>
  </div>

  <!-- Load Three.js and Globe.gl -->
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script>
    const textureURLs = {
      satellite: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
      political: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Political_World_Map_2021.png',
      topo: 'https://eoimages.gsfc.nasa.gov/images/imagerecords/74000/74192/world.topo.bathy.200412.3x5400x2700.jpg',
      ecoregions: 'https://storage.googleapis.com/eco-globe-maps/ecoregions.jpg'
    };

    const globe = Globe()(document.getElementById('globeViz'))
      .globeImageUrl(textureURLs.satellite)
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .pointAltitude(0.01)
      .pointColor('color')
      .pointRadius('size')
      .labelLat('lat')
      .labelLng('lng')
      .labelText('label')
      .labelSize(1.2)
      .labelDotRadius(0.3)
      .labelColor(() => 'rgba(255,255,255,0.9)');

    const controls = globe.controls();
    controls.autoRotate = false;
    controls.enableZoom = true;
    controls.zoomSpeed = 1.2;
    controls.minDistance = 50;
    controls.maxDistance = 500;

    document.querySelectorAll("input[name='layer']").forEach(input => {
      input.addEventListener("change", e => {
        const selected = e.target.value;
        globe.globeImageUrl(textureURLs[selected]);
      });
    });

   document.getElementById('zoomInBtn').addEventListener('click', () => {
  // Move camera closer by decreasing distance but clamp to minDistance
  const newDistance = Math.max(controls.getDistance() - 20, controls.minDistance);
  controls.setDistance(newDistance);
});

 document.getElementById('zoomOutBtn').addEventListener('click', () => {
  // Move camera farther by increasing distance but clamp to maxDistance
  const newDistance = Math.min(controls.getDistance() + 20, controls.maxDistance);
  controls.setDistance(newDistance);
});

    const startYearSlider = document.getElementById('startYearSlider');
    const endYearSlider = document.getElementById('endYearSlider');
    const startYearLabel = document.getElementById('startYearLabel');
    const endYearLabel = document.getElementById('endYearLabel');
    const observationCount = document.getElementById('observationCount');

    startYearSlider.addEventListener('input', () => {
      startYearLabel.textContent = startYearSlider.value;
      if (parseInt(startYearSlider.value) > parseInt(endYearSlider.value)) {
        endYearSlider.value = startYearSlider.value;
        endYearLabel.textContent = endYearSlider.value;
      }
    });

    endYearSlider.addEventListener('input', () => {
      endYearLabel.textContent = endYearSlider.value;
      if (parseInt(endYearSlider.value) < parseInt(startYearSlider.value)) {
        startYearSlider.value = endYearSlider.value;
        startYearLabel.textContent = startYearSlider.value;
      }
    });

    const tooltipDiv = document.getElementById('tooltip');

    // ðŸ§  Moved outside search handler â€” this runs ONCE
    globe.onPointHover(point => {
      if (point) {
        tooltipDiv.innerHTML = point.tooltip;
        tooltipDiv.style.display = 'block';
      } else {
        tooltipDiv.style.display = 'none';
      }
    });

    document.addEventListener('mousemove', e => {
      tooltipDiv.style.left = `${e.clientX + 10}px`;
      tooltipDiv.style.top = `${e.clientY + 10}px`;
    });

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const species = document.getElementById('speciesInput').value.trim();
      const startYear = parseInt(startYearSlider.value);
      const endYear = parseInt(endYearSlider.value);
      if (!species) return alert("Please enter a species name.");

      const encoded = encodeURIComponent(species);
      const url = `https://api.gbif.org/v1/occurrence/search?scientificName=${encoded}&limit=300&year=${startYear},${endYear}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        const points = data.results
          .filter(obs => obs.decimalLatitude && obs.decimalLongitude)
          .map(obs => {
            const lat = obs.decimalLatitude;
            const lng = obs.decimalLongitude;
            const year = obs.year || "Unknown";
            const country = obs.country || "Unknown";
            const speciesName = obs.species || species;
            const imageUrl = (obs.media && obs.media.length && obs.media[0].identifier) || null;

            const label = `${speciesName}\n${country}, ${year}`;
            const tooltip = `
              <div style="text-align:left;">
                <strong>${speciesName}</strong><br/>
                <em>${country}</em><br/>
                Year: ${year}<br/>
                Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}<br/>
                ${imageUrl ? `<img src="${imageUrl}" width="100" style="margin-top:5px;border-radius:4px;" />` : ""}
              </div>
            `;

            return {
              lat,
              lng,
              year,
              label,
              tooltip,
              color: 'orange',
              size: 0.4
            };
          });

        globe.pointsData([]);           // Clear previous points
        globe.pointsData(points);       // Set new points
        observationCount.textContent = `Observations: ${points.length}`;
      } catch (err) {
        console.error(err);
        observationCount.textContent = 'Observations: 0';
        alert("Failed to load GBIF data.");
      }
    });
  </script>
</body>
</html>
