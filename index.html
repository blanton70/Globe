<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Globe with Layer Switching</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    #globeViz {
      height: 100%;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div id="controls">
    <label><input type="radio" name="layer" value="satellite" checked> Satellite</label><br>
    <label><input type="radio" name="layer" value="political"> Political</label><br>
    <label><input type="radio" name="layer" value="topo"> Topographic</label><br>
    <label><input type="radio" name="layer" value="ecoregions"> Ecoregions</label>
    <hr/>
<input type="text" id="speciesInput" placeholder="Enter species name (e.g. Panthera leo)">
<button id="searchBtn">Search</button>
   <hr />
<label for="startYearSlider">Start Year: <span id="startYearLabel">1800</span></label><br />
<input type="range" id="startYearSlider" min="1800" max="2025" step="1" value="1800" /><br />

<label for="endYearSlider">End Year: <span id="endYearLabel">2025</span></label><br />
<input type="range" id="endYearSlider" min="1800" max="2025" step="1" value="2025" /><br />
<p id="observationCount">Observations: 0</p>

  </div>

  <!-- Load Globe.gl and Three.js -->
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script>

  const textureURLs = {
    satellite: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
    political: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Political_World_Map_2021.png',
    topo: 'https://eoimages.gsfc.nasa.gov/images/imagerecords/74000/74192/world.topo.bathy.200412.3x5400x2700.jpg',
    ecoregions: 'https://storage.googleapis.com/eco-globe-maps/ecoregions.jpg'
  };

  const globe = Globe()(document.getElementById('globeViz'))
    .pointsData([])
    .pointAltitude(0.01)
    .pointColor('color')
    .pointRadius('size')
    .globeImageUrl(textureURLs.satellite)
    .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .labelLat('lat')
  .labelLng('lng')
  .labelText('label')  // Use the `label` field as hover content
  .labelSize(1.8)
  .labelDotRadius(0.4)
  .labelColor(() => 'rgba(255, 255, 255, 0.8)')
  .labelResolution(3);

  globe.controls().autoRotate = true;
  globe.controls().autoRotateSpeed = 0.3;

  document.querySelectorAll("input[name='layer']").forEach(input => {
    input.addEventListener("change", e => {
      const selected = e.target.value;
      globe.globeImageUrl(textureURLs[selected]);
    });
  });

  const startYearSlider = document.getElementById('startYearSlider');
  const endYearSlider = document.getElementById('endYearSlider');
  const startYearLabel = document.getElementById('startYearLabel');
  const endYearLabel = document.getElementById('endYearLabel');
  const observationCount = document.getElementById('observationCount');

  // ðŸŸ¡ Update year labels on slider move
  startYearSlider.addEventListener('input', () => {
    startYearLabel.textContent = startYearSlider.value;
    clampYears();
  });

  endYearSlider.addEventListener('input', () => {
    endYearLabel.textContent = endYearSlider.value;
    clampYears();
  });

  // ðŸ”’ Prevent start year > end year
  function clampYears() {
    const start = parseInt(startYearSlider.value);
    const end = parseInt(endYearSlider.value);

    if (start > end) {
      endYearSlider.value = start;
      endYearLabel.textContent = start;
    }
  }

  document.getElementById('searchBtn').addEventListener('click', async () => {
    const species = document.getElementById('speciesInput').value.trim();
    const startYear = parseInt(startYearSlider.value, 10);
    const endYear = parseInt(endYearSlider.value, 10);

    if (!species) return alert('Enter a species name');

    const encoded = encodeURIComponent(species);
    const url = `https://api.gbif.org/v1/occurrence/search?scientificName=${encoded}&year=${startYear},${endYear}&limit=300`;

    try {
      const res = await fetch(url);
      const data = await res.json();

const points = data.results
  .filter(obs => obs.decimalLatitude && obs.decimalLongitude)
  .map(obs => {
    const lat = obs.decimalLatitude;
    const lng = obs.decimalLongitude;
    const year = obs.year || "Unknown year";
    const country = obs.country || "Unknown country";
    const species = obs.species || species;

    const imageUrl = (obs.media && obs.media.length && obs.media[0].identifier) || null;

    const labelHTML = `
      <div style="text-align:left; max-width: 200px;">
        <strong>${species}</strong><br/>
        <em>${country}</em><br/>
        Year: ${year}<br/>
        Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}<br/>
        ${imageUrl ? `<img src="${imageUrl}" width="100" style="margin-top:5px;border-radius:4px;" />` : ""}
      </div>
    `;

    return {
      lat,
      lng,
      year,
      color: 'orange',
      size: 0.4,
      label: labelHTML
    };
  });


      globe.pointsData(points);
      observationCount.textContent = `Observations: ${points.length}`;
    } catch (err) {
      console.error(err);
      observationCount.textContent = `Observations: 0`;
      alert('Failed to load species data');
    }
  });
</script>
</body>
</html>
